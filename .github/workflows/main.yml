name: CI/CD with Auto-Merge and Dev Check (Yarn)

on:
  push:
    branches:
      - '**'

jobs:
  ci-cd:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Step 2: Set up Docker Compose
      - name: Start Docker Compose
        run: |
          docker-compose up -d
          docker-compose ps

      # Step 3: Wait for MongoDB
      - name: Wait for MongoDB
        run: |
          for i in {1..10}; do
            if docker exec mongodb mongo -u root -p example --authenticationDatabase admin --eval "db.getMongo()" >/dev/null 2>&1; then
              echo "MongoDB is ready!";
              exit 0;
            fi
            echo "Waiting for MongoDB...";
            sleep 5;
          done
          echo "MongoDB did not start in time.";
          exit 1;

      # Step 4: Install dependencies
      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # Step 5: Start the development server in the background
      - name: Start the dev server
        run: |
          yarn dev &
          sleep 5  # Give the server time to start

      # Step 6: Check if http://localhost:3000 is available
      - name: Wait for the server to be ready
        run: npx wait-on http://localhost:3000

      # Step 7: Auto-merge to `dev` if successful
      - name: Auto-merge to `dev`
        uses: pascalgn/automerge-action@v0.15.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          mergeMethod: merge
          branch: dev
